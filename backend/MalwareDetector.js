const Utils = require("./Utils");
const mmmagic = require('mmmagic');
const fs = require('fs');
const path = require('path');

class MalwareDetector {
    constructor(socket, EmailSender) {
        this.socket = socket;
        this.EmailSender = EmailSender;
    }

    async malwareDetected(threatType, maliciousInput, attacker) {
        attacker = attacker === "" ? "Unknown" : attacker;
        const threatMessage = `${threatType} Attack Detected! Attacker: ${attacker}, Malicious Input: ${maliciousInput}\n`;
        Utils.writeToLogFile('../guardianvault/threats_log.txt', threatMessage);
        await this.EmailSender.sendAdminThreatAlert(threatType, attacker);
    }

    async validateMagicBytes(buffer, fileName, attacker) {
        const filePath = path.join(__dirname, fileName);
        fs.writeFileSync(filePath, buffer);
        const magic = new mmmagic.Magic(mmmagic.MAGIC_MIME_TYPE);
        
        magic.detectFile(filePath, async (error, result) => {
            if (error) {
                console.error('Error detecting file type:', error);
                return;
            }
    
            console.log('Detected file type:', result);
        });
    
        fs.unlink(filePath, (err) => {
            if (err) {
                console.error(`Error deleting file: ${err}`);
            }
        });
    }
}

module.exports = { MalwareDetector };
